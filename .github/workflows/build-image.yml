name: Build and Push Docker Image

on:
  push:
    branches: [main]
    tags:
      - '*'
  pull_request:
    branches: [main]


permissions:
  id-token: write
  actions: read
  contents: read



jobs:
  container:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      # push to ECR in Aws
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ECR_ROLE }} #change to reflect your IAM role's ARN
          aws-region: ${{ vars.AWS_REGION_ECR }}

      # Hello from AWS: WhoAmI
      - name: Sts GetCallerIdentity
        run: |
          aws sts get-caller-identity
          
      - name: Authenticate to AWS ECR
        run: |
          aws ecr get-login-password --region ${{ vars.AWS_REGION_ECR }} | docker login --username AWS --password-stdin ${{ vars.AWS_AIRWAYZ_ECR_ADDRESS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          # list of Docker image to use as base name for tags
          images: |
            ${{ vars.AWS_AIRWAYZ_ECR_ADDRESS }}/${{ github.event.repository.name }}
          # generate Docker tags based on the following events/attributes
          tags: |
            type=schedule
            type=ref,event=branch
            type=ref,event=tag
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .  # Use the root directory of the repository as the context
          file: Dockerfile  # Specify the path to the Dockerfile relative to the root
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64,linux/arm64

  detect-and-update-yaml-k8s: # Runs only for merge to main branch
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      needs: container

      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository (main repo)
          uses: actions/checkout@v4
          with:
            fetch-depth: 0 

        - name: Install required tools only
          run: |
            # Install yq for YAML manipulation
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
            
            # jq is pre-installed on GitHub runners
          
        - name: Checkout k8s-config repo
          uses: actions/checkout@v4
          with:
            repository: 'Airwayz-Drones/k8s-config'
            ref: main
            path: k8s-config
            token: ${{ secrets.PAT_K8S_CONFIG }}

        - name: Get latest commit SHA
          id: vars
          run: echo "SHA=$(git rev-parse --short=7 HEAD)" >> $GITHUB_ENV
        - name: update tag 
          uses: Airwayz-Drones/actions-changetag@v1.0.6
          with:
              mode: ussp
              servicename: "ussp_api_tests" # enter the service name placehollder 
              newtag: sha-${SHA}
              env: "helm-dev" # not in use for know 
              secret-token: ${{ secrets.PAT_K8S_CONFIG }}      
